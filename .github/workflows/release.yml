name: ðŸ“Release

on:
    push:
        tags:
            - 'v*'

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Verify tag is on master
              run: |
                  git fetch origin master
                  if ! git merge-base --is-ancestor "${{ github.sha }}" origin/master; then
                    echo "::error::Tag is not on master â€” skipping release"
                    exit 1
                  fi

            - name: Extract release notes from CHANGELOG
              id: changelog
              run: |
                  VERSION="${{ github.ref_name }}"
                  VERSION_NUMBER="${VERSION#v}"

                  RELEASE_NOTES=$(awk -v ver="$VERSION_NUMBER" '
                    $0 ~ "^## \\[?" ver "\\]?([[:space:]]|$)" { found=1; next }
                    found && /^## / { exit }
                    found { print }
                  ' CHANGELOG.md | sed '/^[[:space:]]*$/{ /./!d }')

                  if [ -z "$RELEASE_NOTES" ]; then
                    RELEASE_NOTES="Release ${VERSION_NUMBER}"
                  fi

                  echo "$RELEASE_NOTES" > /tmp/release_notes.md

            - name: Create GitHub Release
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  VERSION="${{ github.ref_name }}"
                  gh release create "$VERSION" \
                    --title "$VERSION" \
                    --notes-file /tmp/release_notes.md
